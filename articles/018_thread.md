本記事では、Rubyで並行(concurrent)に処理を行う手段である、Threadとforkの解説を行います。


### スレッド(Thread)とは

スレッド(Thread)とは、ひとつのプロセス上で複数の処理を実行させる際の処理単位です。

Ruby1.8まではOSに依存しないユーザレベルのスレッド(これを[グリーンスレッド](http://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89)と呼びます)を使っていましたが、スレッド切り替えが頻繁に起こる際のパフォーマンス向上を目的に、1.9以降はネイティブ スレッド(= OS組み込み)を利用する実装に変更されています。

ただしここで注意すべきは、基本的にRubyのスレッドは複数のネイティブ スレッドを同時に使うことは出来ない、という点です。リファレンスマニュアルに概要が記載されているので引用します。

> ネイティブ スレッドを用いて実装されていますが、 現在の実装では Ruby VM は Giant VM lock (GVL) を有しており、同時に実行される ネイティブ スレッドは常にひとつです。 ただし、IO 関連のブロックする可能性があるシステムコールを行う場合には GVL を解放します。その場合にはスレッドは同時に実行され得ます。 また拡張ライブラリから GVL を操作できるので、複数のスレッドを 同時に実行するような拡張ライブラリは作成可能です。
>
> [スレッド - Ruby2.1.0リファレンスマニュアル](http://docs.ruby-lang.org/ja/2.1.0/doc/spec=2fthread.html)

つまり、RubyのスレッドはIO処理(ディスクの読み書きやネットワーク通信)に関しては並列(parallel)に実行できますが、それ以外のスレッド実行は「プロセスよりも細かい時間単位でスレッドを切り替える」ことにより並列っぽく見せているだけのもので、仮にある一瞬で時間停止して見たとすればその瞬間に実行中のスレッドは一つです。


### Threadの使い方

それでは実際にスレッドを使ってみましょう。

`Thread.new`することで新しいスレッドが作成され、これブロックを与えるとで新スレッドでブロック内のコードが実行されることになります。以下は、スレッドを使って画像を100枚並列でダウンロードする例です。

（ちなみに[CamBelt.co: The Leading Cam Belt Site on the Net](http://cambelt.co/)はダミー画像を生成してくれるサービス）

<script src="https://gist.github.com/759e37d33b7298787ad1.js?file=thread.rb"></script>

スレッドを使わず同じタスクを行う以下のコードも用意して、

<script src="https://gist.github.com/759e37d33b7298787ad1.js?file=no_thread.rb"></script>

速度を比較してみます。

<script src="https://gist.github.com/759e37d33b7298787ad1.js?file=time.sh"></script>

スレッドを使わない場合が26.136秒、スレッドを使った場合は0.123秒と大幅な改善が見られます。


[次のページ](/gm/gc/446444/2/)では、別プロセスを生み出して処理を実行させるforkについて説明します。

<div style="page-break-after: always"><span style="display: none">&nbsp;</span></div>


### forkとプロセス

forkはプロセスを複製します。先に「スレッドはひとつのプロセス上で複数の処理を実行させる」際の話だと書きましたが、プロセスはスレッドよりも大きな処理の単位です。

早速forkを使ってみます。`Thread.new do...end` の代わりに`fork do...end`としてブロックをforkに渡してやるコードは次のように書けます。

<script src="https://gist.github.com/759e37d33b7298787ad1.js?file=fork.rb"></script>

このときプロセスを監視していると、`ruby fork.rb`というプロセスが10個立ち上がっているのがわかります。

<script src="https://gist.github.com/759e37d33b7298787ad1.js?file=ps_fork.sh"></script>

スレッドの場合は以下のようにプロセスは1個だけです。スレッドは同じプロセス内で走るため、メモリ空間を共有しておりデータが簡単に共有できます。

<script src="https://gist.github.com/759e37d33b7298787ad1.js?file=ps_thread.sh"></script>


### おわりに

以上でThreadとforkの基本的な解説は終了です。並列・平行プログラミングはマルチコア化の進んだ現在重要なテーマの一つであると言えるため、後日本記事に追加するか、別記事としてまとめる形で引き続き扱っていきたいと思います。
